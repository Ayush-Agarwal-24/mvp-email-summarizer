const state = { filter: "all", emails: [], byId: {}, acts: {}, me: { connected: false } };
const list = document.getElementById("list");
const refresh = document.getElementById("refresh");
const connect = document.getElementById("connect");
const userEl = document.getElementById("user");
const statusEl = document.getElementById("status");
const modal = document.getElementById('modal');
const modalContent = document.getElementById('modal-content');
const modalClose = document.getElementById('modal-close');
const modalImport = document.getElementById('modal-import');
let modalEmailId = null;
function ftime(s) { try { return new Date(s).toLocaleString() } catch (e) { return "" } }
function card(e) { const sid = "s-" + e.id; const chips = '<div class="chips" id="' + sid + '"></div>'; const link = '<a class="btn" href="' + (e.gmail_url || "#") + '" target="_blank">Open</a>'; return '<div class="card"><div class="row"><div><div class="subject">' + (e.subject || "(no subject)") + '</div><div class="meta">' + (e.sender || "") + ' • ' + (ftime(e.received_at) || "") + '</div></div><div>' + link + '</div></div><div class="summary" id="sum-' + e.id + '"></div>' + chips + '<div class="actions"><button class="btn" data-act="done" data-id="' + e.id + '">Done</button><button class="btn" data-act="snooze" data-id="' + e.id + '">Snooze 1d</button></div></div>' }
function passFilter(e) { if (state.filter === "all") return true; const a = state.acts[e.id]; if (!a) return false; if (state.filter === "tasks") return (a.tasks || []).length > 0; if (state.filter === "meetings") return (a.meetings || []).length > 0; if (state.filter === "deadlines") return (a.deadlines || []).length > 0; return true }
function cardx(e) { const sid = "s-" + e.id; const chips = '<div class="chips" id="' + sid + '"></div>'; const link = '<a class="btn" href="' + (e.gmail_url || "#") + '" target="_blank">Open</a>'; const details = '<button class="btn" data-act="details" data-id="' + e.id + '">Details</button>'; return '<div class="card"><div class="row"><div><div class="subject">' + (e.subject || "(no subject)") + '</div><div class="meta">' + (e.sender || "") + ' • ' + (ftime(e.received_at) || "") + '</div></div><div style="display:flex;gap:8px">' + details + link + '</div></div><div class="summary" id="sum-' + e.id + '"></div>' + chips + '<div class="actions"><button class="btn" data-act="done" data-id="' + e.id + '">Done</button><button class="btn" data-act="snooze" data-id="' + e.id + '">Snooze 1d</button></div></div>' }
function render() { const rows = state.emails.filter(passFilter).map(cardx).join(""); list.innerHTML = rows; state.emails.forEach(function (e) { const sEl = document.getElementById('sum-' + e.id); if (sEl) sEl.textContent = 'Loading...'; const cEl = document.getElementById('s-' + e.id); if (cEl) cEl.innerHTML=''; loadSummary(e.id) }) }
function setMe() { if (state.me.connected) { if (connect) connect.style.display = 'none'; if (userEl) userEl.textContent = state.me.email ? ('Connected as ' + state.me.email) : 'Connected' } else { if (connect) connect.style.display = 'inline-block'; if (userEl) userEl.textContent = '' } }
function setStatus(text, isError) { if (!statusEl) return; statusEl.textContent = text || ''; statusEl.className = isError ? 'status error' : 'status' }
async function req(url, opt) { const r = await fetch(url, opt); if (!r.ok) return null; return r.json() }
async function loadMe() { const me = await req('/api/me'); state.me = me || { connected: false }; setMe(); if (!state.me.connected) setStatus('Connect Gmail to start') }
async function loadEmails() { if (!state.me.connected) { list.innerHTML=''; return } setStatus('Loading emails...'); if (refresh) refresh.disabled = true; const data = await req('/api/emails?limit=50'); if (refresh) refresh.disabled = false; if (!data) { setStatus('Failed to load emails', true); return } state.emails = Array.isArray(data) ? data : []; state.byId = {}; state.emails.forEach(function (e) { state.byId[e.id] = e }); if (state.emails.length === 0) { setStatus('No emails to show') } else { setStatus('') } render() }
async function loadSummary(id) {
    const res = await req('/api/summarize', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email_id: id }) }); const sEl = document.getElementById('sum-' + id); if (!res) { if (sEl) sEl.textContent = 'Failed to summarize'; return } if (sEl) sEl.textContent = res.summary_text || ""; let acts = { tasks: [], meetings: [], deadlines: [] }; try { acts = JSON.parse(res.actions_json || "{}") } catch (e) { }
    state.acts[id] = acts; const chipsEl = document.getElementById('s-' + id); if (!chipsEl) return; const all = []; (acts.tasks || []).forEach(function (a) { all.push('task: ' + (a.title || "")) }); (acts.meetings || []).forEach(function (a) { all.push('meeting: ' + (a.title || "") + (a.when_text ? ' • ' + a.when_text : "")) }); (acts.deadlines || []).forEach(function (a) { all.push('deadline: ' + (a.title || "") + (a.when_text ? ' • ' + a.when_text : "")) }); chipsEl.innerHTML = all.map(function (x) { return '<span class="chip">' + x + '</span>' }).join("")
}
list.addEventListener('click', async function (ev) {
    const b = ev.target.closest('button.btn'); if (!b) return; const act = b.getAttribute('data-act'); const id = parseInt(b.getAttribute('data-id'), 10); if (act === 'done') { await req('/api/items', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email_id: id, type: 'task', title: 'Done' }) }) }
    if (act === 'snooze') { const until = new Date(Date.now() + 86400000).toISOString(); const r = await req('/api/items', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email_id: id, type: 'task', title: 'Snoozed' }) }); if (r && r.id) { await req('/api/items/' + r.id, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ status: 'snoozed', snooze_until: until }) }) } }
    if (act === 'details') { openDetails(id) }
})

function renderChipsBlock(acts) { const rows = []; (acts.tasks || []).forEach(function (a) { rows.push('<div><span class="chip">task</span> ' + (a.title || '') + '</div>') }); (acts.meetings || []).forEach(function (a) { rows.push('<div><span class="chip">meeting</span> ' + (a.title || '') + (a.when_text ? ' • ' + a.when_text : '') + '</div>') }); (acts.deadlines || []).forEach(function (a) { rows.push('<div><span class="chip">deadline</span> ' + (a.title || '') + (a.when_text ? ' • ' + a.when_text : '') + '</div>') }); return rows.join('') }

function openDetails(id) { modalEmailId = id; if (!modal || !modalContent) return; const e = state.byId[id]; let acts = state.acts[id] || { tasks: [], meetings: [], deadlines: [] }; const sumEl = document.getElementById('sum-' + id); const summaryText = sumEl ? sumEl.textContent : ''; const top = '<div class="subject">' + (e.subject || '(no subject)') + '</div><div class="meta">' + (e.sender || '') + ' • ' + (ftime(e.received_at) || '') + '</div>'; const body = '<div class="summary" style="margin-top:8px">' + (summaryText || '') + '</div>'; const chips = '<div style="margin-top:10px">' + renderChipsBlock(acts) + '</div>'; modalContent.innerHTML = top + body + chips; modal.classList.remove('hidden') }

if (modalClose) modalClose.addEventListener('click', function(){ modal.classList.add('hidden'); modalEmailId = null })
if (modalImport) modalImport.addEventListener('click', async function(){ if (!modalEmailId) return; modalImport.disabled = true; const r = await req('/api/actions/import', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email_id: modalEmailId }) }); modalImport.disabled = false; if (r && typeof r.created === 'number') { setStatus('Imported ' + r.created + ' actions') } else { setStatus('Failed to import actions', true) } })
document.querySelectorAll('.tab').forEach(function (btn) { btn.addEventListener('click', function () { document.querySelectorAll('.tab').forEach(function (x) { x.classList.remove('active') }); btn.classList.add('active'); state.filter = btn.getAttribute('data-filter') || 'all'; render() }) })
refresh.addEventListener('click', function(){ loadEmails() })
loadMe().then(loadEmails)
